'''
Created on Nov 22, 2017

@author: martin
'''

import pandas as pd
from numpy import arange

from Search import Search
from Test import Test

from sklearn.naive_bayes import GaussianNB
from sklearn.tree import DecisionTreeClassifier as DTree
from sklearn.ensemble import RandomForestClassifier
from sklearn.neighbors import KNeighborsClassifier
from sklearn.svm import SVC

def yn_to_10(x):
    if x == "y":
        return 1
    elif x == "n":
        return 0
    else:
        return 2

def transform(data):
    for col in ["handicapped-infants","water-project-cost-sharing","adoption-of-the-budget-resolution","physician-fee-freeze","el-salvador-aid","religious-groups-in-schools","anti-satellite-test-ban","aid-to-nicaraguan-contras","mx-missile","immigration","synfuels-crporation-cutback","education-spending","superfund-right-to-sue","crime","duty-free-exports","export-administration-act-south-africa"]:
        data[col]= data[col].apply(yn_to_10)

labelFunE= lambda x: 0 if x == "republican" else 1
labelFunD= lambda x: "republican" if x == 0 else "democrat"
        
def runGnb(X,y):
    print("GaussianNB")
    h= Test(X, y, GaussianNB())
    h.run()
    h.labelFun(labelFunD)
    h.report(fn="../Report/results/congress.gnb.cm.tex")
    s= Search(X, y, GaussianNB(), [{}])
    s.search()
    s.report("../Report/results/congress.gnb.tex")
    
def runDT(X, y):
    print("DecisionTreeClassifier")
    parameters=[{'criterion' :['gini', 'entropy'], 'max_features': ['auto', 'sqrt', 'log2']}]
    s= Search(X, y, DTree(), parameters)
    s.search()
    s.report("../Report/results/congress.dt.tex")
    h= Test(X, y, DTree(criterion='gini',random_state=1234))
    h.run()
    h.report(fn="../Report/results/congress.dt.cm.tex")
    print("RF")
    parameters= [{'n_estimators' : range(10, 20), 'criterion' :['gini', 'entropy'], 'max_features': ['auto', 'sqrt', 'log2']}]
    s= Search(X, y, RandomForestClassifier(), parameters)
    s.search()
    s.report("../Report/results/congress.rf.tex", )
    h= Test(X, y, RandomForestClassifier(n_estimators= 12, criterion='gini', max_features='log2',random_state=1234))
    h.run()
    h.labelFun(labelFunD)
    h.report(fn="../Report/results/congress.rf.cm.tex")
    
def runSVM(X, y):
    C_range = 10. ** arange(-3, 8)
    gamma_range = 10. ** arange(-5, 4)
    parameters=[{'kernel' : ['linear','sigmoid', 'rbf', 'poly'], 'C' : C_range, 'gamma':gamma_range}]
    parameters=[{'kernel' : ['rbf'], 'C' : [50,90,99,100,101], 'gamma':gamma_range}]
    print("SVM")
    from sklearn import preprocessing
    X_scaled = preprocessing.scale(X)
    s= Search(X_scaled, y, SVC(), parameters)
    # s.search(cv=2)
    s.search()
    s.report("../Report/results/congress.svm.tex")
    h= Test(X, y, SVC(C=1, kernel='sigmoid', gamma=0.10000000000000001))
    h.run()
    h.labelFun(labelFunD)
    h.report(fn="../Report/results/congress.svm.cm.tex")
    
def runKNN(X, y):
    print("KNeighborsClassifier")
    parameters= [{'n_neighbors' : range(4, 8), 'weights':['uniform', 'distance'], 'p':[1, 2]}]
    s= Search(X, y, KNeighborsClassifier(), parameters)
    s.search()
    s.report("../Report/results/congress.knn.tex")
    h= Test(X, y, KNeighborsClassifier(n_neighbors=6, weights='distance', p=2))
    h.run()
    h.labelFun(labelFunD)
    h.report(fn="../Report/results/congress.knn.cm.tex")

def main(fn):
    data= pd.read_csv(fn)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
    
    # Features to be used in classification
    features = ["handicapped-infants", \
                #"water-project-cost-sharing", \
                "adoption-of-the-budget-resolution", \
                "physician-fee-freeze", \
                "el-salvador-aid", \
                "religious-groups-in-schools",
                "anti-satellite-test-ban", \
                "aid-to-nicaraguan-contras", \
                "mx-missile", \
                "immigration", \
                "synfuels-crporation-cutback", \
                "education-spending", \
                #"superfund-right-to-sue", \
                "crime", \
                "duty-free-exports", \
                "export-administration-act-south-africa"\
                ]
    
    transform(data)
    
    X= data[features]
    #y= data['class'].apply(lambda x: labels.index(x))
    y= data['class'].apply(labelFunE)
    
#     runGnb(X,y)
    
#     runDT(X,y)
    
#     runSVM(X,y)

#     runKNN(X,y)
    
    o= pd.read_csv("../data/CongressionalVotingID.shuf.test.csv")
    transform(o)
    
    print("DT")
#     parameters=[{'kernel' : ['linear','sigmoid', 'rbf', 'poly']}]
#     s= Search(X, y, SVC(), parameters)
#     s.search()
    h= Test(X, y, DTree(criterion='gini', max_features='log2', random_state=1234))
    h.run()
    h.labelFun(labelFunD)
    h.report(fn="../Report/results/congress.dt.cm.tex")
    o['class']= h.predict(o[features])
    o['class']= o['class'].apply(labelFunD)
    o.to_csv("out_congress.csv", columns=['ID','class'], header=['ID',str("class")],index=False)


if __name__ == '__main__':
    # main("../data/kddcup.data.corrected")
    main("../data/CongressionalVotingID.shuf.train.csv")

